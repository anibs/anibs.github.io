<!DOCTYPE html>
<html lang="en">
	<head>
		<title>WebAR</title>
		
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
		<script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-analytics.js"></script>

		<style>

			.intro{
				text-align:center;
				border-style: solid;
				border-color: aqua;
			}

			.centerimg {
			  display: block;
			  margin-left: auto;
			  margin-right: auto;	
			}


			.loading{
				margin:auto;
				padding-left:135px;
			}


			body {
			  font-family: "Lato", sans-serif;
			  color:"white";
			}

			.sidenav {
			  height: 75%;
			  width: 0;
			  position: fixed;
			  z-index: 1;
			  top: 0;
			  left: 0;
			  background-color: #BFBFBF;
			  overflow-x: hidden;
			  transition: 0.5s;
			  padding-top: 60px;

			}

			.sidenav a {
			  padding: 8px 8px 8px 32px;
			  text-decoration: none;
			  font-size: 25px;
			  color: #818181;
			  display: block;
			  transition: 0.3s;
			}

			.sidenav a:hover {
			  color: #f1f1f1;
			}

			.sidenav .closebtn {
			  position: absolute;
			  top: 0;
			  right: 25px;
			  font-size: 36px;
			  margin-left: 50px;
			}

			@media screen and (max-height: 450px) {
			  .sidenav {padding-top: 15px;}
			  .sidenav a {font-size: 18px;}
			}

			.openButton{
				font-size:30px;cursor:pointer;
				margin-left:5px;
				margin-top:5px;
			}

			.asset_info{
				font-size:20px;
				padding-left:10px;
			}
				
			.extrathumbnail{
				padding-left: 20px;
			}

			
}

		</style>

	</head>
	<body>
		
		<div id='div' style='position: fixed;'>
			</br></br>
			<img id='loading' class="loading" height='50' width='50'>
			<button id="screenshot" type="button">Save...</button>
			
			<div id="mySidenav" class="sidenav">
				<a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
				<p id='assetinfo' class='asset_info' style='color:white;'>Product : </p>
				<button id='one' class='extrathumbnail'></button>
				</br></br>
				<button type='img' id='two' class='extrathumbnail' src='' height='150' width='150'>
			</div>
			<div class='openButton'>
			<span  onclick="openNav()">&#9776; open</span>
			</div>
			
		
		</div>
		

		<script>
			function openNav() {
			  document.getElementById("mySidenav").style.width = "250px";
			}

			function closeNav() {
			  document.getElementById("mySidenav").style.width = "0";
			}


			


		</script>


		<script type="module">

			//var id=0;
			var location_name='';
			
			location_name=location.search;
			console.log(location_name);
			var asset_name=location_name.substring(4);
			console.log(asset_name);


			var firebaseConfig = {
                apiKey: "AIzaSyDJecdvv4l-AIl7du5YpPy-RnoSJcRHOtU",
                authDomain: "hello-world-2f407.firebaseapp.com",
                databaseURL: "https://hello-world-2f407.firebaseio.com",
                projectId: "hello-world-2f407",
                storageBucket: "hello-world-2f407.appspot.com",
                messagingSenderId: "494069966463",
                appId: "1:494069966463:web:838651b9443a334cfe014a",
                measurementId: "G-YMCEW9C328"
            };
            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            firebase.analytics();
			const db=firebase.firestore();
			var list_glbs=[];
			var list_names=[];
			var list_thumbnail_one=[];
			var list_thumbnail_two=[];
			let glb="";
			let name="";
			var thumbone,thumbtwo
			db.settings({timestampsInSnapshots : true});

			

			db.collection('assets').get().then((snapshot)=>{
				//console.log(snapshot.docs);
				console.log(snapshot.docs.length);
				snapshot.docs.forEach(doc=>{
					//console.log(doc.data().files[0]);
					if(asset_name==doc.data().asset_name){
						
						glb=doc.data().files[0];
						if(doc.data().files.length>2){
							thumbone=doc.data().files[2];
							//list_thumbnail_one.push(thumbone);
							thumbtwo=doc.data().files[3]
							//list_thumbnail_two.push(thumbtwo);
						}
						else{
							thumbone='';
							//list_thumbnail_one.push(thumbone);
							thumbtwo='';
							//list_thumbnail_two.push(thumbtwo);
						}
					
						name=doc.data().asset_name;
						//list_glbs.push(glb);
						//list_names.push(name);
					}
					
				})
				
				/*for(var i=0;i<list_names.length;i++){
					if(list_names[i]==asset_name){
						console.log(i);
						id=i;
						break;
					}
				}*/
			})

			import * as THREE from './build/three.module.js';
			import { ARButton } from './jsm/webxr/ARButton.js';
			import { OrbitControls } from './jsm/controls/OrbitControls.js';
			import { DragControls } from './jsm/controls/DragControls.js';
			import { GLTFLoader } from './jsm/loaders/GLTFLoader.js';
			
			let container;var clicksone=0;var clickstwo=0;
			let camera, scene, renderer, controls, dragcontrols;
			let controller;
			var obj=[];
			let composer;
			
			var infobutton;var divObj;var loadinggif;

			let reticle;
			var changeMat, originalCol;
			let hitTestSource = null;
			let hitTestSourceRequested = false;
			var c=0;
			let spotlight,spotlight2;
			
			init();
			animate();			

			function init() {

				container = document.getElementById('div');
				document.body.appendChild( container );

				scene = new THREE.Scene();

				camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 1000 );
				

				const light = new THREE.AmbientLight(0xffffff, 1);
				light.position.set(10,10,10);
				const directionalLight = new THREE.DirectionalLight(0xffffff, 4);
				directionalLight.position.set(10, 100, 10);

				directionalLight.castShadow = true;

				
				scene.add(light);
				scene.add(directionalLight);


				renderer = new THREE.WebGLRenderer( { antialias: true, alpha: true } );

				renderer.xr.enabled = true;
				renderer.xr.enabled = true;
				renderer.shadowMap.enabled = true;
				container.appendChild( renderer.domElement );

				controls= new OrbitControls(camera, renderer.domElement);
				controls.addEventListener('change', render);
				controls.minDistance = 2;
				controls.maxDistance = 10;
				controls.target.set(0, 0, -0.2);
				controls.enableDamping = true;
				controls.dampingFactor = 0.05;
				
				dragcontrols = new DragControls( obj, camera, renderer.domElement );
				dragcontrols.addEventListener( 'drag', render );

				let options={
					requiredFeatures:['hit-test'],
					optionalFeatures:['dom-overlay'],
				}
				options.domOverlay={root:document.getElementById('div')};
				document.body.appendChild( ARButton.createButton( renderer, options ) );



				function onSelect() {
					if(c==0){
						if (reticle.visible){
							console.log(typeof ojb);
							const loader = new GLTFLoader();
							loader.crossOrigin='true';
							console.log(asset_name);
							//console.log(id);
							// Load a glTF resource
							//loadinggif=document.createElement('image');
							document.getElementById('loading').src='./loading.gif';
							const planeGeometry = new THREE.PlaneGeometry(2000, 2000);
							planeGeometry.rotateX(-Math.PI / 2);

							const shadowMesh = new THREE.Mesh(planeGeometry, new THREE.ShadowMaterial({
								color: 0x111111,
								opacity: 0.3,
							}));	

							shadowMesh.position.setFromMatrixPosition( reticle.matrix );
							shadowMesh.name = 'shadowMesh';
							shadowMesh.receiveShadow = true;
							shadowMesh.position.y = -1.85;

							scene.add(shadowMesh);
							loader.load(

								String(glb),
								function ( gltf ) {
									var count =0 ;
									obj=gltf.scene;
									obj.scale.set(0.75, 0.75, 0.75);
									obj.rotateY( - Math.PI / 4 ),
									obj.position.setFromMatrixPosition( reticle.matrix );
									obj.position.y+=0;
									obj.castShadow=true;
									obj.traverse(function(node) {
										if (node.isMesh) {
											
											if(count==0){
												count=1;
												changeMat=node.name;
												originalCol=node.material.color.getHex();
												
												//console.log(originalCol.r, originalCol.g, originalCol.b);
											}
											node.castShadow = true;
											node.material.depthTest=true;
											node.material.depthWrite=true;
											
										}
									});
		
									scene.add(obj);
									scene.remove(reticle);
									var box = new THREE.Box3();
									box.setFromObject(obj);
									box.getCenter(controls.target);

									controls.update();
									render();

									//controls.update();
									//render();

									//for multiple obj part
									/*if(obj.length>3){
										console.log("removing")
										scene.remove(obj[obj.length - 1]);
										obj.pop();
										c--;
										animate();
									}*/

									loadinggif=document.getElementById('loading');
									loadinggif.remove();
									var asset_nameele=document.getElementById('assetinfo').textContent+=asset_name;
									var imgone=document.getElementById('one');
									imgone.innerHTML='<img src='+thumbone+' height='+120+' width='+120+'/>';
									var imgtwo=document.getElementById('two');
									imgtwo.innerHTML='<img src='+thumbtwo+' height='+120+' width='+120+'/>';
									
									imgone.onclick=function MatOne() {
										
										clicksone++;
										
										obj.traverse(function(node) {
											if (node.isMesh) {
												
												if(node.name==changeMat){
													if(clicksone%2==0){
														node.material.color.setHex(originalCol);
													}
													else{
														node.material.color.setHex(0xff4500);
													}
												}
											}
										});
									}
									
									imgtwo.onclick=function MatTwo() {
										clickstwo++;
										
										obj.traverse(function(node) {
											if (node.isMesh) {
												
												if(node.name==changeMat){
													if(clickstwo%2==0){
														node.material.color.setHex(originalCol);
													}
													else{
														node.material.color.setHex(0xffff00);
													}
												}
											}
										});
									}
									//c++;//for multiple objs part
									

								}
								
							);

							
						}
						c+=1;
			
					}
				}

				controller = renderer.xr.getController( 0 );
				controller.addEventListener( 'select', onSelect );
				scene.add( controller );

				reticle = new THREE.Mesh(
					new THREE.RingGeometry( 0.15, 0.2, 32 ).rotateX( - Math.PI / 2 ),
					new THREE.MeshBasicMaterial()
				);
				reticle.matrixAutoUpdate = false;
				reticle.visible = false;
				scene.add( reticle );

				window.addEventListener( 'resize', onWindowResize, false );

				renderer.domElement.addEventListener('touchstart', function(e){
					e.preventDefault();
					touchDown=true;
					touchX = e.touches[0].pageX;
					touchY = e.touches[0].pageY;
				}, false);

				renderer.domElement.addEventListener('touchend', function(e){
					e.preventDefault();
					touchDown = false;
				}, false);

				renderer.domElement.addEventListener('touchmove', function(e){
					e.preventDefault();
					
					if(!touchDown){
						return;
					}

					deltaX = e.touches[0].pageX - touchX;
					deltaY = e.touches[0].pageY - touchY;
					touchX = e.touches[0].pageX;
					touchY = e.touches[0].pageY;

					rotateObject();

				}, false);
			}

			var touchDown, touchX, touchY, deltaX, deltaY;

			function rotateObject(){
				if(current_object && reticle.visible){
					current_object.rotation.y += deltaX / 100;
				}
			}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize( window.innerWidth, window.innerHeight );
				//animate();
			}

			function animate() {

				renderer.setAnimationLoop( render );
				requestAnimationFrame( animate );
				controls.update();
			}

			function render( timestamp, frame ) {

				if ( frame ) {

					const referenceSpace = renderer.xr.getReferenceSpace();
					const session = renderer.xr.getSession();

					if ( hitTestSourceRequested === false ) {

						session.requestReferenceSpace( 'viewer' ).then( function ( referenceSpace ) {

							session.requestHitTestSource( { space: referenceSpace } ).then( function ( source ) {

								hitTestSource = source;

							} );

						} );

						session.addEventListener( 'end', function () {

							hitTestSourceRequested = false;
							hitTestSource = null;

							var box = new THREE.Box3();
							box.setFromObject(obj);
							box.getCenter(controls.target);

						} );

						hitTestSourceRequested = true;

					}

					if ( hitTestSource ) {

						const hitTestResults = frame.getHitTestResults( hitTestSource );

						if ( hitTestResults.length ) {

							const hit = hitTestResults[ 0 ];

							reticle.visible = true;
							reticle.matrix.fromArray( hit.getPose( referenceSpace ).transform.matrix );

						} else {

							reticle.visible = false;

						}

					}

				}
				renderer.render( scene, camera );
			}

			const elem = document.querySelector('#screenshot');
			const canvas = renderer.domElement;
			elem.addEventListener('click', () => {
				canvas.toBlob((blob) => {
					saveBlob(blob, `screencapture.png`);
				});
			});

			const saveBlob = (function() {
			const a = document.createElement('a');
			document.body.appendChild(a);
			a.style.display = 'none';
			return function saveData(blob, fileName) {
				const url = window.URL.createObjectURL(blob);
				a.href = url;
				a.download = fileName;
				a.click();
			};
			}());

		</script>
	</body>
</html>
